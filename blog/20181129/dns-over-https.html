
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DNS Over Https RFC8484 - 冷雨之家</title>
  <meta name="author" content="Spring">

  
  <meta name="description" content="本文主要记录一下自己学习RFC8484 DNS Queries over HTTPS (DoH)时的简单翻译。 1.Introduction RFC8484 定义了一种通过https链路来发送DNS请求和接受DNS响应的协议。每一对DNS的请求和响应对应一次http的交换。 This &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://douxinchun.github.io/blog/20181129/dns-over-https.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  
  <link href="/atom.xml" rel="alternate" title="冷雨之家" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>&#8211;>
  <!--<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.min.js"></script>&#8211;>
  <!--为了添加scroll_to_top.html 提高了js的版本-->
  <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.3.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts-->
<link href="/stylesheets/pt_serif.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/pt_sans.css" rel="stylesheet" type="text/css">
  

  <script>
  	function addBlankTargetForLinks () {
  	  $('a[href^="http"]').each(function(){
  		  $(this).attr('target', '_blank');
  	  });
  	}
  	$(document).bind('DOMNodeInserted', function(event) {
  	  addBlankTargetForLinks();
  	});
  </script>
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/"><img style="border-radius:50%" src="/images/head.png" width=60 height=60 />
冷雨之家</a></h1>
  
    <h2>Dying is the day worth living for</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="douxinchun.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">博客</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/aboutme">关于我</a></li>
  
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">DNS Over Https RFC8484</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-29T22:31:53+08:00'><span class='date'>2018 年11 月29 日</span> <span class='time'>10:31 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://douxinchun.github.io">Comments</a>
        
		<!--
	    
		-->
      </p>
    
  </header>


<div class="entry-content"><p>本文主要记录一下自己学习RFC8484 DNS Queries over HTTPS (DoH)时的简单翻译。</p>

<h2>1.Introduction</h2>

<p>RFC8484 定义了一种通过https链路来发送DNS请求和接受DNS响应的协议。每一对DNS的请求和响应对应一次http的交换。</p>

<blockquote><p>This document defines a protocol for sending DNS queries and getting   DNS responses over HTTPS.  Each DNS query-response pair is mapped   into an HTTP exchange.</p></blockquote>

<p>本文描述的方法不仅仅是基于http的隧道。DoH为请求和响应增加了默认的媒体格式类型（meida formatting type），使用http内容协商机制来选择替代品，因为终端可能会更希望能服务于新的使用场景（水平有限，这句搞不定）。除此之外，DoH具有http的特性，比如，缓存，重定向，代理，认证和压缩。</p>

<blockquote><pre><code>The described approach is more than a tunnel over HTTP.  It establishes default media formatting types for requests and responses but uses normal HTTP content negotiation mechanisms for selecting alternatives that endpoints may prefer in anticipation of serving new use cases.  In addition to this media type negotiation, it aligns itself with HTTP features such as caching, redirection, proxying, authentication, and compression.
</code></pre></blockquote>

<p>这种与http的集成为现有的DNS客户端和web应用的dns查询提供一种传输层的适配。</p>

<blockquote><pre><code>The integration with HTTP provides a transport suitable for both existing DNS clients and native web applications seeking access to the DNS.
</code></pre></blockquote>

<p>在协议的开发过程中主要考虑了两点，一是阻止路径上的其它设备对DNS操作产生妨碍，二是允许web应用以现有的浏览器API用一种安全的方式来获取DNS信息，而且与CORS（这个概念不清楚）保持一致。其余方面未做额外的工作。该文档着重说明在DNS客户端（eg，操作系统的根解析器）和递归解析服务器之间的通信过程。</p>

<blockquote><pre><code>Two primary use cases were considered during this protocol's development.  These use cases are preventing on-path devices from interfering with DNS operations, and also allowing web applications to access DNS information via existing browser APIs in a safe way consistent with Cross Origin Resource Sharing (CORS).  No special effort has been taken to enable or prevent application to other use cases.  This document focuses on communication between DNS clients (such as operating system stub resolvers) and recursive resolvers.
</code></pre></blockquote>

<h2>2.  Terminology</h2>

<p>DoH Server:  支持DoH协议的服务器。</p>

<p>DNS Server：普通的传输层协议的DNS服务器，UDP 53 端口</p>

<p>DoH Clieng： 支持DoH协议的客户端</p>

<p>must 一定要， must not 绝对不能，required 必要的， shall 应该， shall not 不应该，should 应该（语气轻），should not 不应该（语气轻），recommend 建议，recommend not 建议不要， may 可以， optional 可选</p>

<h2>3.Selection of DoH Server</h2>

<p>这段没用，主要是讲DoH Server支持客户端各种URI的配置，只要client的配置符合URI规范就行。</p>

<blockquote><pre><code>The DoH client is configured with a URI Template [RFC6570], which describes how to construct the URL to use for resolution. Configuration, discovery, and updating of the URI Template is done out of band from this protocol.  Note that configuration might be manual (such as a user typing URI Templates in a user interface for "options") or automatic (such as URI Templates being supplied in responses from DHCP or similar protocols).  DoH servers MAY support more than one URI Template.  This allows the different endpoints to have different properties, such as different authentication requirements or service-level guarantees.
</code></pre></blockquote>

<p>这段也没用，[rfc2818]描述了https协议是怎样确认DoH Server的主机身份的。</p>

<blockquote><pre><code>A DoH client uses configuration to select the URI, and thus the DoH server, that is to be used for resolution.  [RFC2818] defines how HTTPS verifies the DoH server's identity.
</code></pre></blockquote>

<p>一个Client一定不能使用两个不同的URI。这里看不懂</p>

<blockquote><pre><code>A DoH client MUST NOT use a different URI simply because it was discovered outside of the client's configuration (such as through HTTP/2 server push) or because a server offers an unsolicited response that appears to be a valid answer to a DNS query.  This specification does not extend DNS resolution privileges to URIs that are not recognized by the DoH client as configured URIs.  Such scenarios may create additional operational, tracking, and security hazards that require limitations for safe usage.  A future specification may support this use case.
</code></pre></blockquote>

<h2>4，The HTTP Exchange</h2>

<h3>4.1 The HTTP Request</h3>

<p>Doh Client 使用GET或者POST 方法来封装DNS请求到http请求中。</p>

<blockquote><pre><code>A DoH client encodes a single DNS query into an HTTP request usingeither the HTTP GET or POST method and the other requirements of this section.  The DoH server defines the URI used by the request through the use of a URI Template.
</code></pre></blockquote>

<p>当http method为POST时，DNS请求中的URI不能携带任何参数；当为GET时，DNS请求中需要一个名为“dns”的参数（详情参见第6节），需要使用base64进行编码。</p>

<blockquote><pre><code>The URI Template defined in this document is processed without any variables when the HTTP method is POST.  When the HTTP method is GET,the single variable "dns" is defined as the content of the DNS request (as described in Section 6), encoded with base64url [RFC4648].
</code></pre></blockquote>

<p>将来有关DoH的新的媒体类型一定会定义URI模板使用的参数。DoH需要同时实现GET方法和POST方法。</p>

<blockquote><pre><code>Future specifications for new media types for DoH MUST define the variables used for URI Template processing with this protocol.

DoH servers MUST implement both the POST and GET methods.
</code></pre></blockquote>

<p>使用POST方法，DNS请求被放在http请求的body体中。http request中Content-Type会指明body中message的类型。通常来讲，同等条件下，post请求比get的要小。</p>

<blockquote><pre><code>When using the POST method, the DNS query is included as the message body of the HTTP request, and the Content-Type request header field indicates the media type of the message.  POSTed requests are generally smaller than their GET equivalents.
</code></pre></blockquote>

<p>使用GET方法有利于http缓存的实现（可能是因为幂等性）。</p>

<blockquote><pre><code>Using the GET method is friendlier to many HTTP cache implementations.
</code></pre></blockquote>

<p>DoH Client 应该在http的rquest字段中制定一个Accept字段，用来表明在返回的响应中哪种类型的内容可以被接受。不管request中的Accept的字段是什么值，Client一定要处理“application/dns-message”类型（详情参见章节6），也可以处理其它dns相关的媒体类型。</p>

<blockquote><pre><code> The DoH client SHOULD include an HTTP Accept request header field to indicate what type of content can be understood in response.Irrespective of the value of the Accept request header field, the client MUST be prepared to process "application/dns-message" (as
described in Section 6) responses but MAY also process other DNS-related media types it receives.
</code></pre></blockquote>

<p>为了最大化的利用http缓存。DoH Client使用含有DNS报文中的ID字段的媒体类型。后续不是很理解，以后有机会再看。</p>

<blockquote><pre><code>In order to maximize HTTP cache friendliness, DoH clients using media formats that include the ID field from the DNS message header, such as "application/dns-message", SHOULD use a DNS ID of 0 in every DNS request.  HTTP correlates the request and response, thus eliminating the need for the ID in a media type such as "application/dns-message".  The use of a varying DNS ID can cause semantically equivalent DNS queries to be cached separately.
</code></pre></blockquote>

<p>可以使用http/2中的padding和compressing特性。</p>

<blockquote><pre><code>DoH clients can use HTTP/2 padding and compression [RFC7540] in the same way that other HTTP/2 clients use (or don't use) them.
</code></pre></blockquote>

<h2>4.1.1 HTTP Request Example</h2>

<p>HTTP/2-style [rfc7540]</p>

<p>请求解析一个A记录</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"https://dnsserver.example.net/dns-query{?dns}" to resolve IN A records.</span></code></pre></td></tr></table></div></figure>


<p>请求解析域名 &ldquo;www.example.com&rdquo;</p>

<p>GET</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:method = GET
</span><span class='line'>:scheme = https
</span><span class='line'>:authority = dnsserver.example.net
</span><span class='line'>:path = /dns-query?dns=AAABAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB
</span><span class='line'>accept = application/dns-message</span></code></pre></td></tr></table></div></figure>


<p>POST</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:method = POST
</span><span class='line'>:scheme = https
</span><span class='line'>:authority = dnsserver.example.net
</span><span class='line'>:path = /dns-query
</span><span class='line'>accept = application/dns-message
</span><span class='line'>content-type = application/dns-message
</span><span class='line'>content-length = 33
</span><span class='line'>
</span><span class='line'>&lt;33 bytes represented by the following hex encoding&gt;
</span><span class='line'>00 00 01 00 00 01 00 00  00 00 00 00 03 77 77 77
</span><span class='line'>07 65 78 61 6d 70 6c 65  03 63 6f 6d 00 00 01 00
</span><span class='line'>01</span></code></pre></td></tr></table></div></figure>


<p>采用的是DNS wire format的形式，body中放的是33字节的DMS报文，从DNS协议头开始。</p>

<h2>4.2  The HTTP Response</h2>

<p> 文档中定义的唯一的response type是“application/dns-message”.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Spring</span></span>

      




<time class='entry-date' datetime='2018-11-29T22:31:53+08:00'><span class='date'>2018 年11 月29 日</span> <span class='time'>10:31 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dns/'>dns</a>, <a class='category' href='/blog/categories/doh/'>doh</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/20180928/function-pointer-test.html" title="Previous Post: C 语言函数指针小测试">&laquo; C 语言函数指针小测试</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

<!--

-->
</div>

<aside class="sidebar">
  
    <section>
  <h1><a href="/aboutme" >About Me</a></h1>
  <img src="/images/head.png" width=200 height=200 style="border-radius:5%" /><br />
  <b>Spring, 程序员</b>
  <p>博观而约取, 厚积而薄发</p>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/20181129/dns-over-https.html">DNS Over Https RFC8484</a>
      </li>
    
      <li class="post">
        <a href="/blog/20180928/function-pointer-test.html">C 语言函数指针小测试</a>
      </li>
    
      <li class="post">
        <a href="/blog/20180920/tips-of-google-search.html">Chrome中使用英文关键词搜索中文结果</a>
      </li>
    
      <li class="post">
        <a href="/blog/20180918/tips-of-xcode.html">Xcode 使用技巧</a>
      </li>
    
      <li class="post">
        <a href="/blog/20180725/introduction-to-lipo.html">Lipo 使用简介</a>
      </li>
    
  </ul>
</section>




<section>
  <h1>文章分类</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/c/'>c (1)</a></li>
<li class='category'><a href='/blog/categories/css/'>css (1)</a></li>
<li class='category'><a href='/blog/categories/der/'>der (1)</a></li>
<li class='category'><a href='/blog/categories/dns/'>dns (1)</a></li>
<li class='category'><a href='/blog/categories/doh/'>doh (1)</a></li>
<li class='category'><a href='/blog/categories/function-pointer/'>function pointer (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (1)</a></li>
<li class='category'><a href='/blog/categories/goagent/'>goagent (1)</a></li>
<li class='category'><a href='/blog/categories/google/'>google (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (9)</a></li>
<li class='category'><a href='/blog/categories/ioskai-fa-guo-cheng-zhong-yu-dao-de-keng/'>ios开发过程中遇到的坑 (1)</a></li>
<li class='category'><a href='/blog/categories/linux/'>linux (1)</a></li>
<li class='category'><a href='/blog/categories/lipo/'>lipo (1)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (1)</a></li>
<li class='category'><a href='/blog/categories/mac-os-x/'>mac os x (2)</a></li>
<li class='category'><a href='/blog/categories/macbook-pro/'>macbook pro (1)</a></li>
<li class='category'><a href='/blog/categories/macos/'>macos (1)</a></li>
<li class='category'><a href='/blog/categories/objective-c/'>objective_c (1)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (6)</a></li>
<li class='category'><a href='/blog/categories/openssl/'>openssl (1)</a></li>
<li class='category'><a href='/blog/categories/pem/'>pem (1)</a></li>
<li class='category'><a href='/blog/categories/provisioning-profile/'>provisioning profile (1)</a></li>
<li class='category'><a href='/blog/categories/rsa/'>rsa (2)</a></li>
<li class='category'><a href='/blog/categories/ssd/'>ssd (1)</a></li>
<li class='category'><a href='/blog/categories/static-library/'>static library (1)</a></li>
<li class='category'><a href='/blog/categories/terminal/'>terminal (3)</a></li>
<li class='category'><a href='/blog/categories/xcode/'>xcode (7)</a></li>
<li class='category'><a href='/blog/categories/xcodebuild/'>xcodebuild (1)</a></li>
<li class='category'><a href='/blog/categories/bing-yu-huo-zhi-ge/'>冰与火之歌 (1)</a></li>

  </ul>
</section><section>
  <h1>近期评论</h1>
  <script type="text/javascript" src="http://newspringblog.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>
  
</section>
<section>
<h1>访客地图</h1>
<script type="text/javascript" src="//ra.revolvermaps.com/0/0/6.js?i=0qld21p02br&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=0" async="async"></script>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Spring -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'newspringblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://douxinchun.github.io/blog/20181129/dns-over-https.html';
        var disqus_url = 'http://douxinchun.github.io/blog/20181129/dns-over-https.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











  <script type="text/javascript" src="http://arrow.scrolltotop.com/arrow78.js"></script>
<noscript>Not seeing a <a href="http://www.scrolltotop.com/">Scroll to Top Button</a>? Go to our FAQ page for more info.</noscript>

</body>
</html>
